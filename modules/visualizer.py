import streamlit as st
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
import numpy as np
import calendar
import pandas as pd

def plot_annual_overview(df_vis_year, col_bat, selected_vis_year):

    
    factor = 5/60 
    st.markdown(f"### ðŸ“… Annual Overview ({selected_vis_year})")

    df_monthly_vis = df_vis_year.set_index('timestamp').copy()
    df_monthly_vis['pv_kwh'] = df_monthly_vis['solar_output_kw'] * factor
    df_monthly_vis['bat_dis_kwh'] = df_monthly_vis[col_bat].apply(lambda x: x if x > 0 else 0) * factor
    df_monthly_vis['grid_imp_kwh'] = df_monthly_vis['grid_net_kw'].apply(lambda x: x if x > 0 else 0) * factor

    df_monthly_agg = df_monthly_vis[['pv_kwh', 'bat_dis_kwh', 'grid_imp_kwh']].resample('ME').sum()
    df_monthly_agg['month_name'] = df_monthly_agg.index.strftime('%b') 
    
    df_monthly_agg['total_supply'] = df_monthly_agg['pv_kwh'] + df_monthly_agg['bat_dis_kwh'] + df_monthly_agg['grid_imp_kwh']
    df_monthly_agg['total_supply'] = df_monthly_agg['total_supply'].replace(0, 1)
    
    df_monthly_agg['pct_pv'] = (df_monthly_agg['pv_kwh'] / df_monthly_agg['total_supply']) * 100
    df_monthly_agg['pct_bat'] = (df_monthly_agg['bat_dis_kwh'] / df_monthly_agg['total_supply']) * 100
    df_monthly_agg['pct_grid'] = (df_monthly_agg['grid_imp_kwh'] / df_monthly_agg['total_supply']) * 100
    
    colors = ['#1f77b4', '#8c564b', '#add8e6'] 
    months = df_monthly_agg['month_name']

    # --- BARIS 1 (Energy Source kWh & Percentage) ---
    c1, c2 = st.columns(2)
    
    with c1:
        fig1, ax1 = plt.subplots(figsize=(6, 4))
        ax1.bar(months, df_monthly_agg['pv_kwh'], color=colors[0], label='PV')
        ax1.bar(months, df_monthly_agg['bat_dis_kwh'], bottom=df_monthly_agg['pv_kwh'], color=colors[1], label='Bat Discharge')
        ax1.bar(months, df_monthly_agg['grid_imp_kwh'], bottom=df_monthly_agg['pv_kwh']+df_monthly_agg['bat_dis_kwh'], color=colors[2], label='Grid Import')
        
        ax1.set_title("Monthly Energy Source")
        ax1.set_ylabel("Energy (kWh)")
        ax1.legend(fontsize='small', loc='lower right')
        ax1.grid(axis='y', alpha=0.3)
        plt.tight_layout() 
        st.pyplot(fig1)

    with c2:
        fig2, ax2 = plt.subplots(figsize=(6, 4))
        ax2.bar(months, df_monthly_agg['pct_pv'], color=colors[0], label='PV')
        ax2.bar(months, df_monthly_agg['pct_bat'], bottom=df_monthly_agg['pct_pv'], color=colors[1], label='Bat Discharge')
        ax2.bar(months, df_monthly_agg['pct_grid'], bottom=df_monthly_agg['pct_pv']+df_monthly_agg['pct_bat'], color=colors[2], label='Grid Import')
        
        ax2.set_title("Energy Contribution")
        ax2.set_ylabel("Percentage (%)")
        ax2.set_ylim(0, 100)
        ax2.legend(fontsize='small', loc='lower right')
        ax2.grid(axis='y', alpha=0.3)
        plt.tight_layout() 
        st.pyplot(fig2)

    # --- BARIS 2 (VPP Heatmap & Negative Price Heatmap) ---
    c3, c4 = st.columns(2)

    with c3:
        if 'vpp_status' in df_vis_year.columns:
            df_vis_year['vpp_minutes'] = df_vis_year['vpp_status'].apply(lambda x: 5 if x else 0)
            
            daily_vpp = df_vis_year.set_index('timestamp')['vpp_minutes'].resample('D').sum().reset_index()
            
            daily_vpp['m'] = daily_vpp['timestamp'].dt.month
            daily_vpp['d'] = daily_vpp['timestamp'].dt.day
            
            heatmap_data = daily_vpp.pivot(index='m', columns='d', values='vpp_minutes')
            heatmap_data = heatmap_data.reindex(index=range(1, 13), columns=range(1, 32))
            
            data_matrix = heatmap_data.fillna(0).to_numpy()
            
            fig_heat, ax_h = plt.subplots(figsize=(6, 4))
            
            import matplotlib.colors as mcolors
            cmap_custom = mcolors.LinearSegmentedColormap.from_list("WhiteOrange", ["white", "orange", "#8B4500"])
            
            max_val = data_matrix.max()
            vmax_val = max(max_val, 60) 
            
            im = ax_h.imshow(data_matrix, cmap=cmap_custom, aspect='auto', interpolation='nearest', vmin=0, vmax=vmax_val)
            
            ax_h.set_xticks(np.arange(0, 31, 2))
            ax_h.set_xticklabels(np.arange(1, 32, 2), fontsize=7)
            ax_h.set_yticks(np.arange(12))
            ax_h.set_yticklabels([calendar.month_abbr[i] for i in range(1, 13)], fontsize=8)
            
            ax_h.set_title("VPP Discharge")
            
            cbar = ax_h.figure.colorbar(im, ax=ax_h, fraction=0.046, pad=0.04)
            cbar.ax.tick_params(labelsize=8)
            cbar.set_label("Minutes Active")
            
            plt.tight_layout()
            st.pyplot(fig_heat)
        else:
            st.info("No VPP Status Data Available")

    with c4:
        col_price = 'price_import' if 'price_import' in df_vis_year.columns else 'price_profile'
        
        if col_price in df_vis_year.columns:
            df_vis_year['neg_minutes'] = df_vis_year[col_price].apply(lambda x: 5 if x < 0 else 0)
            
            daily_neg = df_vis_year.set_index('timestamp')['neg_minutes'].resample('D').sum().reset_index()
            
            daily_neg['m'] = daily_neg['timestamp'].dt.month
            daily_neg['d'] = daily_neg['timestamp'].dt.day
            
            heatmap_neg = daily_neg.pivot(index='m', columns='d', values='neg_minutes')
            heatmap_neg = heatmap_neg.reindex(index=range(1, 13), columns=range(1, 32))
            
            data_matrix_neg = heatmap_neg.fillna(0).to_numpy()
            
            fig_neg, ax_n = plt.subplots(figsize=(6, 4))
            
            cmap_neg = mcolors.LinearSegmentedColormap.from_list("WhiteGreen", ["white", "#2ecc71", "#006400"])
            
            max_val_n = data_matrix_neg.max()
            vmax_val_n = max(max_val_n, 60)
            
            im_n = ax_n.imshow(data_matrix_neg, cmap=cmap_neg, aspect='auto', interpolation='nearest', vmin=0, vmax=vmax_val_n)
            
            ax_n.set_xticks(np.arange(0, 31, 2))
            ax_n.set_xticklabels(np.arange(1, 32, 2), fontsize=7)
            ax_n.set_yticks(np.arange(12))
            ax_n.set_yticklabels([calendar.month_abbr[i] for i in range(1, 13)], fontsize=8)
            
            ax_n.set_title("VPP Charge")
            
            cbar_n = ax_n.figure.colorbar(im_n, ax=ax_n, fraction=0.046, pad=0.04)
            cbar_n.ax.tick_params(labelsize=8)
            cbar_n.set_label("Minutes Active")
            
            plt.tight_layout()
            st.pyplot(fig_neg)
        else:
            st.info("Price Data Not Available")


    #Baris 3 Normal Vs VPP Discharge
    df_bat = df_vis_year.copy()
    df_bat['vpp_dis_kw'] = df_bat.apply(
        lambda x: x[col_bat] if (x.get('vpp_status') == True and x[col_bat] > 0) else 0, axis=1
    )
    df_bat['norm_dis_kw'] = df_bat.apply(
        lambda x: x[col_bat] if (x.get('vpp_status') == False and x[col_bat] > 0) else 0, axis=1
    )
    daily_bat = df_bat.set_index('timestamp')[['vpp_dis_kw', 'norm_dis_kw']].resample('D').sum() * factor
    
    fig_break, ax_b = plt.subplots(figsize=(12, 3.5))
    colors_bat = ['#d35400', '#55a868'] 
    labels_bat = ['VPP Discharge', 'Normal Discharge']
    
    ax_b.stackplot(daily_bat.index, 
                   daily_bat['vpp_dis_kw'], 
                   daily_bat['norm_dis_kw'],
                   colors=colors_bat, labels=labels_bat, alpha=0.8)
    
    ax_b.set_title("VPP Discharge VS Normal Discharge")
    ax_b.set_ylabel("Energy (kWh)")
    
    ax_b.xaxis.set_major_locator(mdates.MonthLocator())
    ax_b.xaxis.set_major_formatter(mdates.DateFormatter('%b'))
    ax_b.set_xlim(daily_bat.index[0], daily_bat.index[-1])
    
    ax_b.legend(loc='upper right', fontsize='small')
    ax_b.grid(True, alpha=0.3)
    
    plt.tight_layout() 
    st.pyplot(fig_break)


    # Baris 4 Price Profile
    if 'price_profile' in df_vis_year.columns:
        df_price_profile = df_vis_year.set_index('timestamp')['price_profile']
        
        fig_price, ax_p = plt.subplots(figsize=(12, 3)) 
        
        ax_p.plot(df_price_profile.index, df_price_profile, color='black', linewidth=0.5, alpha=0.3)
        
        ax_p.fill_between(df_price_profile.index, df_price_profile, 0, 
                          where=(df_price_profile >= 0), 
                          interpolate=True, color='#2ecc71', alpha=0.6, label='Positive Price')
        
        ax_p.fill_between(df_price_profile.index, df_price_profile, 0, 
                          where=(df_price_profile < 0), 
                          interpolate=True, color='#e74c3c', alpha=0.6, label='Negative Price')
        
        ax_p.set_ylabel("Price (AUD)")
        ax_p.set_title("Electricity Spot Market Price (5 Minutes)")

        ax_p.xaxis.set_major_locator(mdates.MonthLocator())
        ax_p.xaxis.set_major_formatter(mdates.DateFormatter('%b'))
        ax_p.set_xlim(df_price_profile.index[0], df_price_profile.index[-1])
        
        ax_p.grid(True, alpha=0.3)
        ax_p.legend(loc='upper right', fontsize='small')
        
        st.pyplot(fig_price)
    else:
        st.warning("Price profile data not found.")
    
    #Baris ke 4 Grid Net

    if 'grid_net_kw' in df_vis_year.columns:
        factor = 5/60
        s_import = df_vis_year.set_index('timestamp')['grid_net_kw'].clip(lower=0)
        
        s_export = df_vis_year.set_index('timestamp')['grid_net_kw'].clip(upper=0)
        
        df_daily_imp = (s_import * factor).resample('D').sum()
        df_daily_exp = (s_export * factor).resample('D').sum()
        
        fig_grid, ax_g = plt.subplots(figsize=(12, 3)) 
        
        ax_g.plot(df_daily_imp.index, df_daily_imp, color='#e74c3c', linewidth=1, label='Total Import')
        ax_g.fill_between(df_daily_imp.index, df_daily_imp, 0, color='#e74c3c', alpha=0.5)
        
        ax_g.plot(df_daily_exp.index, df_daily_exp, color='#2ecc71', linewidth=1, label='Total Export')
        ax_g.fill_between(df_daily_exp.index, df_daily_exp, 0, color='#2ecc71', alpha=0.5)
        
        ax_g.axhline(0, color='black', linewidth=0.8, linestyle='--')
        
        ax_g.set_ylabel("Energy (kWh)")
        ax_g.set_title("Grid Exchange: Import vs Export")

        ax_g.xaxis.set_major_locator(mdates.MonthLocator())
        ax_g.xaxis.set_major_formatter(mdates.DateFormatter('%b'))
        ax_g.set_xlim(df_daily_imp.index[0], df_daily_imp.index[-1])
        
        ax_g.grid(True, alpha=0.3)
        ax_g.legend(loc='upper right', fontsize='small')
        
        st.pyplot(fig_grid)
    else:
        st.warning("Grid interaction data not found.")


def plot_monthly_analysis(df_vis_month, col_load, selected_month_name, selected_vis_year):

    st.markdown(f"### ðŸ“‰ Monthly Analysis ({selected_month_name} {selected_vis_year})")
    
    c1, c2 = st.columns(2)
    
    with c1:
        df_profile = df_vis_month.groupby(df_vis_month['timestamp'].dt.hour)[['solar_output_kw', col_load]].mean()
        
        max_val = max(df_profile['solar_output_kw'].max(), df_profile[col_load].max())
        y_limit = max_val * 1.1 if max_val > 0 else 1.0

        fig_prof, ax_p1 = plt.subplots(figsize=(6, 4))
        
        color_ghi = 'orange'
        ax_p1.set_xlabel('Hour (0-23)')
        ax_p1.set_ylabel('Solar Output (kW)', color=color_ghi)
        line1 = ax_p1.plot(df_profile.index, df_profile['solar_output_kw'], color=color_ghi, linewidth=2, label='Solar Output')
        ax_p1.tick_params(axis='y', labelcolor=color_ghi)
        ax_p1.grid(True, alpha=0.3)
        ax_p1.set_ylim(0, y_limit) 
        
        ax_p2 = ax_p1.twinx()  
        color_load = '#d62728' 
        ax_p2.set_ylabel('Load (kW)', color=color_load)
        line2 = ax_p2.plot(df_profile.index, df_profile[col_load], color=color_load, linewidth=2, linestyle='--', label='Load Profile')
        ax_p2.tick_params(axis='y', labelcolor=color_load)
        ax_p2.set_ylim(0, y_limit) 
        
        ax_p1.set_title("Avg Daily Profile: Solar vs Load")
    
        lines = line1 + line2
        labels = [l.get_label() for l in lines]
        ax_p1.legend(lines, labels, loc='upper right', fontsize='small')
        
        plt.tight_layout()
        st.pyplot(fig_prof)

    with c2:
        factor = 5/60
        df_heat_solar = df_vis_month.set_index('timestamp')[['irradiance']].resample('h').sum() * factor
        df_heat_solar = df_heat_solar.reset_index()
        df_heat_solar['d'] = df_heat_solar['timestamp'].dt.day
        df_heat_solar['h'] = df_heat_solar['timestamp'].dt.hour
        
        solar_matrix = df_heat_solar.pivot(index='h', columns='d', values='irradiance')
        
        curr_year = df_vis_month['timestamp'].dt.year.iloc[0]
        curr_month = df_vis_month['timestamp'].dt.month.iloc[0]
        days_in_month = calendar.monthrange(curr_year, curr_month)[1]
        
        solar_matrix = solar_matrix.reindex(index=range(24), columns=range(1, days_in_month + 1)).fillna(0)
        data_matrix_solar = solar_matrix.to_numpy()
        
        fig_h_sol, ax_hs = plt.subplots(figsize=(6, 4))
        im_sol = ax_hs.imshow(data_matrix_solar, cmap='YlOrRd', aspect='auto', interpolation='nearest', origin='lower')
        
        ax_hs.set_xlabel("Day")
        ax_hs.set_ylabel("Hour")
        ax_hs.set_title("Irradiance Heatmap")
        
        cbar_sol = ax_hs.figure.colorbar(im_sol, ax=ax_hs, fraction=0.046, pad=0.04)
        cbar_sol.set_label("Irradiance ($Wh/m^2$)")
        plt.tight_layout()
        st.pyplot(fig_h_sol)